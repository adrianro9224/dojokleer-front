import {AfterContentInit, Component} from '@angular/core';
import {FormArray, FormBuilder, FormControl, FormGroup, Validators} from "@angular/forms";
import {ActivatedRoute, Router} from "@angular/router";
import {QuestionsCategory} from "../questions-category.object";
import {AssessmentService} from "../assessment.service";
import {Observable} from "rxjs";
import {RegisterAssessmentAnswerForm} from "../register-assessment-answer-form";

@Component({
  selector: 'app-assessment',
  templateUrl: './assessment.component.html',
  styleUrls: ['./assessment.component.scss']
})
export class AssessmentComponent implements AfterContentInit {
  currentAssessmentId: number;

  constructor(
    private _formBuilder: FormBuilder,
    private router: Router,
    private assessmentService: AssessmentService,
    private route: ActivatedRoute
  ) {
    this.currentAssessmentId = <number><unknown>this.route.snapshot.paramMap.get('id');
    console.log(this.currentAssessmentId);
  }

  theFormGroup: FormGroup;
  private _theFormArray: FormArray
  isEditable = true;

  categoryTree$: Observable<QuestionsCategory[]>

  ngAfterContentInit(){
    //this.categoryTree = [{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:32:11.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":1,"categoryName":"Practicante de Lean-Agile","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":1,"question":"Question 1 ?","questionCategoryId":1,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":1,"questionId":1,"answer":"Tengo conocimientos basado en lecturas o libros. Asistí a un taller de Scrum o Kanban. Me certifiqué como CSM.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":2,"questionId":1,"answer":"Fui parte de un equipo ágil. He trabajado bajo un framework ágil por lo menos un año. Facilité esporádicamente sesiones de equipos ágiles.","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":3,"questionId":1,"answer":"Puedo darle soporte a uno o más equipos ágiles. Puedo identificar la mejor técnica para usar en cada contexto. Participo de comunidades de práctica. He participado de múltiples equipos en escala.","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":4,"questionId":1,"answer":"Me desenvuelvo más por principios que por prácticas. Puedo trabajar con diferentes equipos, situaciones, topologías e industrias. Soy capaz de combinar diferentes estrategias de escalado. ","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":5,"questionId":1,"answer":"Soy capaz de ayudar a cualquier equipo en cualquier estadío. Mis decisiones están más basada en la intuición y la experiencia. Soy creador de técnicas.","brings":10}]}]},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:32:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":2,"categoryName":"Entrenador","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":2,"question":"Question 2 ?","questionCategoryId":2,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":6,"questionId":2,"answer":"Tengo conocimientos sólidos en mi especialidad. He enseñado de manera informal. No tengo conocimientos de técnicas de enseñanza.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":7,"questionId":2,"answer":"He dictado alguna clase o seminario. He sido tutor o asistente de training. Conozco técnicas como: PBL, POL, Método de Caso.","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":8,"questionId":2,"answer":"He realizado capacitaciones de marcos ágiles con buen feedback. Utilizo Training From the Back, PBL, PBL o Método de Caso. He leído sobre pedagogía.","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":9,"questionId":2,"answer":"Tengo la capacidad de crear contenido customizado basado en las necesidades del equipo y enseñarlos en workshops adaptados. Senso continuamente el espacio de aprendizaje. Enseño a enseñar.","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":10,"questionId":2,"answer":"Puedo co-crear las clases con los alumnos. Tengo alta capacidad de improvisación. Creo modelos de enseñanza.","brings":10}]}]},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:33:13.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":3,"categoryName":"Mentor","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":3,"question":"Question 3 ?","questionCategoryId":3,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":11,"questionId":3,"answer":"Tengo conocimientos sólidos en mi especialidad. Sé distinguir qué es y no es mentorear. Fui mentoreado. Hicer shadow a un mentor. Conozco técnicas de mentoring.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":12,"questionId":3,"answer":"He hecho mentoring alguna vez. He aplicado alguna técnica de mentoring. Soy capaz de identificar patrones basados en la observación.","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":13,"questionId":3,"answer":"Diseño y combino técnicas de mentoring. Compruebo qué funciona y qué no. Elijo el ejemplo justo en función de la problemática del mentee. Adecúo mi estrategia basado en el estilo de aprendizaje del mentee.","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":14,"questionId":3,"answer":"Tengo la capacidad de traer ejemplos metafóricos de otros contextos. Ejecuto el mentoring de forma más exploratoria. Enseño como como mentorear.","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":15,"questionId":3,"answer":"Hago mentoring a “detractores”. Creo frameworks de mentoring. Tengo la habilidad de cultivar otros mentores y mentorearlos.","brings":10}]}]},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:33:56.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":4,"categoryName":"Facilitador","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":4,"question":"Question 4 ?","questionCategoryId":4,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":16,"questionId":4,"answer":"Conozco dinámicas simples (icebreakers). Puedo ser guardían del tiempo o guardían del propósito en una reunión.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":17,"questionId":4,"answer":"Puedo facilitar las reuniones usuales de mis equipos. Mi capacidad de facilitación es reducida (ej: 10px). Puedo sostener un diseño de facilitación previamente elaborado.","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":18,"questionId":4,"answer":"Tengo conocimientos de dinámicas más complejas. Diseño actividades de facilitación. Puedo facilitar conversaciones difíciles. Tengo conocimiento de Story Telling y Visual Thinking. Mi capacidad de facilitación es moderada (ej:40px)","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":19,"questionId":4,"answer":"Puedo facilitar sesiones en temas desafiantes. Mi capacidad de facilitación es alta (ej:100px+). Puedo tomar lo emergente y adaptarme en tiempo real.","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":20,"questionId":4,"answer":"Facilito conflictos sociales. Tengo la habilidad de abordar la mayoría de disfuncionalidades en la sala de cualquier grupo. Facilito a facilitadores.","brings":10}]}]},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:34:23.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":5,"categoryName":"Coach","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":5,"question":"Question 5 ?","questionCategoryId":5,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":21,"questionId":5,"answer":"Hice una formación pero he tenido poca práctica.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":22,"questionId":5,"answer":"Estoy muy pendiente de la estructura del coaching. Tengo expectativas propias de la sesión. Escucho para validar lo que sé. Tengo menos de 100 horas de coaching","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":23,"questionId":5,"answer":"Tengo la capacidad de escuchar en más de un nivel. Hago preguntas poderosas y utilizo metáforas. Tengo la capacidad de identificar un quiebre. Tengo menos de 500 horas de coaching.","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":24,"questionId":5,"answer":"Confío en mi intuición. No tengo expectativas, no tengo que demostrar nada. Escucho inmerso en lo que me está diciendo el cliente. Mi coachee habla bastante, yo mucho menos. Tengo menos de 2500 horas de coaching.","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":25,"questionId":5,"answer":"Soy un líder reconocido del movimiento del coaching.","brings":10}]}]},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:35:12.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":6,"categoryName":"Maestría Técnica","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":6,"question":"Question 6 ?","questionCategoryId":6,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":26,"questionId":6,"answer":"Tengo conocimientos teóricos sobre los principios/prácticas de: XP, Agile Testing, DevOps, Software Craftsmanship y Clean Code. Conozco sobre las actividades del ciclo de vida de desarrollo de software. Tengo conocimiento teórico sobre arquitectura e infraestructura moderna.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":27,"questionId":6,"answer":"He participado de equipos que realizan algunos principios y prácticas. Entiendo los beneficios de los principios/prácticas y cómo aportan al negocio. He recibido mentoría sobre el tema o llevado algún workshop.","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":28,"questionId":6,"answer":"Ayudo a equipos a adoptar principios/prácticas. Conozco cómo configurar herramientas que habilitan cierta prácticas. Conozco un conjunto más amplio de elemento alrededor de los diferentes marco de trabajo.","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":29,"questionId":6,"answer":"Puedo evaluar un equipo para encontrar problemas y oportunidades. Uso métricas para evaluar el impacto de las iniciativas. ","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":30,"questionId":6,"answer":"Experimento continuamente para generar nuevo conocimiento. Ayudo a la organización y a la industria a mejorar sistemáticamente desde el ámbito técnico.","brings":10}]}]},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:35:54.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":7,"categoryName":"Maestría Transformacional","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":7,"question":"Question 7 ?","questionCategoryId":7,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":31,"questionId":7,"answer":"He leído sobre teoría de sistemas y teoría de cambios. Conozco conceptos como Cynefin, Teoría U, Spiral Dynamics, etc. Tengo la capacidad de coordinar.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":32,"questionId":7,"answer":"He trabajado con algún framework de transformación. Tengo la capacidad de escuchar activamente. He trabajado con algún framework de liderazgo.","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":33,"questionId":7,"answer":"Tengo la capacidad de capturar disfuncionalidades dentro de un equipo y trabajar en la organización para habilitar transformaciones en el equipo. He logrado hacer cambios a nivel de equipo.","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":34,"questionId":7,"answer":"Intervengo en el liderazgo de la organización. Tengo la capacidad de capturar disfuncionalidades a nivel organizacional y habilitar un cambio con impacto. Lidero procesos de cambio organizacional.","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":35,"questionId":7,"answer":"Vivo al borde del despido. Tengo la capacidad de articular disfunciones a alto nivel y generar la estrategia correcta para la transformación.","brings":10}]}]},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:36:14.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionCategoryId":8,"categoryName":"Maestría de Negocios","categoryDescription":null,"questionEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:37:39.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionId":8,"question":"Question 8 ?","questionCategoryId":8,"answerEntities":[{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":36,"questionId":8,"answer":"Conozco aspectos básicos de desarrollo de negocios y productos.","brings":2},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":37,"questionId":8,"answer":"He participado de un equipo de producto. Conozco sobre UX, Research, Customer development. Entiendo información estadística para tomar decisiones.","brings":4},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":38,"questionId":8,"answer":"Sé integrar diferente marcos: HCD, Lean Thinking, Product Discovery, Lean Startup. He acompañado a equipos dual-track o end-to-end. He implementado feedback loops de producto. Incorporo conceptos de OKRs e métricas integrales.","brings":6},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":39,"questionId":8,"answer":"Participo en la creación de estrategias de productos. Puedo enseñar las prácticas comunes de gestión de productos. Desarrollé varios productos exitosos.","brings":8},{"createdBy":"254dbb10-b4e9-11ea-b3de-0242ac130004","createdAt":"2020-06-25T01:40:19.000+0000","updatedBy":null,"updatedAt":null,"status":"ACTIVE","questionAnswerId":40,"questionId":8,"answer":"Innovo modelos de negocios en los 3 horizontes de tiempo.","brings":10}]}]}];
    this.theFormGroup = this._formBuilder.group({
      answersByCategory: this._formBuilder.array([])
    });
    this.categoryTree$ = this.assessmentService.getCategoriesTree();
    this.categoryTree$.subscribe(value => {
      value.forEach(value => {
        this._theFormArray = this.theFormGroup.get('answersByCategory') as FormArray;
        this._theFormArray.push(this.addFormGroupByQuestionCategory(value));
      });
    });
  }

  private getQuestionFormControl(){
      return new FormControl('', [Validators.required])
  }

  private addFormGroupByQuestionCategory(category: QuestionsCategory){
    let group: any = {};
    category.questionEntities.forEach(value => {
      group[category.questionCategoryId+'-'+value.questionId] = this.getQuestionFormControl();
    });
    return this._formBuilder.group(group);
  }

  saveAssessmentAnswer(){
    console.log(this.theFormGroup.value);
    console.log(this.theFormGroup);
    let forms = this.theFormGroup.value.answersByCategory;
    let answerIds = [];
    for(let control of forms){
        answerIds.push(control[Object.keys(control)[0]]);
    }
    this.assessmentService.registerAssessmentAnswers(this.currentAssessmentId, new RegisterAssessmentAnswerForm(
      answerIds
    )).subscribe(value => {
      this.router.navigate(['assessment-summary', this.currentAssessmentId]);
    });
  }


  get theFormArray(): FormArray {
    return this._theFormArray;
  }
}
